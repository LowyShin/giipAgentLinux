# RemoteServerSSHTest API - νΈμ¶ κµ¬μ΅° λ…ν™•ν™”

> **μ „μ  λ¬Έμ„**: [GIIPAGENT3_SPECIFICATION.md](./GIIPAGENT3_SPECIFICATION.md)  
> **ν„μ¬ μƒνƒ**: β³ λ‹Ήμ‹ μ μ²΄ν¬ λ€κΈ°

---

## π― κµ¬μ΅° (λ…ν™•ν™”)

### SSH ν…μ¤νΈ νλ¦„

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ Gateway μ„λ²„ (is_gateway=1, LSSN=71174)                β”‚
β”‚                                                         β”‚
β”‚  giipAgent3.sh (Gateway Mode)                          β”‚
β”‚    β†“                                                    β”‚
β”‚  lib/gateway.sh                                         β”‚
β”‚    β†“                                                    β”‚
β”‚  [5.7] SSH ν…μ¤νΈ μ‹μ‘                                   β”‚
β”‚    β†“ (SSHλ¥Ό ν†µν•΄ λ¦¬λ¨νΈ μ„λ²„μ— μ§μ ‘ μ ‘κ·Ό)                 β”‚
β”‚  [5.10] SSH μ—°κ²° κ²°κ³Ό (success λλ” fail)               β”‚
β”‚    β†“                                                    β”‚
β”‚  [5.10.1] RemoteServerSSHTest API νΈμ¶                 β”‚
β”‚    β†“                                                    β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                      β†“
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ RemoteServerSSHTest API (Azure Function)               β”‚
β”‚                                                         β”‚
β”‚ pApiRemoteServerSSHTestbyAK SP μ‹¤ν–‰                    β”‚
β”‚    β†“                                                    β”‚
β”‚ tLSvr ν…μ΄λΈ” μ—…λ°μ΄νΈ                                   β”‚
β”‚    β†“                                                    β”‚
β”‚ LSChkdt = GETUTCDATE()  β… μ—…λ°μ΄νΈλ¨!                  β”‚
β”‚    β†“                                                    β”‚
β”‚ RstVal=200 μ‘λ‹µ                                         β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                      β†“
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ Gateway μ„λ²„ (κ³„μ†)                                     β”‚
β”‚                                                         β”‚
β”‚ [5.10.2] API μ‘λ‹µ RstVal=200 (μ„±κ³µ)                    β”‚
β”‚ [6.2] KVS μ €μ¥ (API νΈμ¶ μ„±κ³µ)                          β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

### ν•µμ‹¬ ν¬μΈνΈ

β… **Gatewayκ°€ λ¦¬λ¨νΈ μ„λ²„μ— SSH ν…μ¤νΈ μ§μ ‘ μ‹¤ν–‰**
- λ¦¬λ¨νΈ μ„λ²„μ `gateway_ssh_host`, `gateway_ssh_user`, `gateway_ssh_port` μ‚¬μ©
- SSH μ—°κ²° μ„±κ³µ/μ‹¤ν¨ νλ‹¨

β… **APIλ” Gatewayμ ν…μ¤νΈ κ²°κ³Όλ¥Ό λ°›μ•„μ„ DBλ§ μ—…λ°μ΄νΈ**
- Gateway β†’ API: "SSH ν…μ¤νΈν–μ–΄. LSChkdt μ—…λ°μ΄νΈν•΄μ¤"
- API β†’ DB: LSChkdt μ—…λ°μ΄νΈ
- API β†’ Gateway: μ‘λ‹µ (RstVal=200)

---

## π“ API νΈμ¶ (μ •ν™•ν• μ‚¬μ–‘)

### νΈμ¶ μ„μΉ

**νμΌ**: `lib/gateway.sh`  
**ν•¨μ**: `process_gateway_servers()`  
**νƒ€μ΄λ°**: SSH ν…μ¤νΈ ν›„ (λ΅κΉ… ν¬μΈνΈ #5.10 λ‹¤μ)

### API μ”μ²­ ν•μ‹

#### μ—”λ“ν¬μΈνΈ
```
POST https://giipfaw.azurewebsites.net/api/giipApiSk2
```

#### Content-Type
```
application/x-www-form-urlencoded
```

#### νλΌλ―Έν„°

**text** (κ³ μ •):
```
RemoteServerSSHTest lssn gateway_lssn test_type
```

**token** (μ„¤μ •):
```
${sk}  (giipAgent.cnfμ—μ„ λ΅λ“ν• Secret Key)
```

**jsondata** (JSON):
```json
{
  "lssn": 71221,
  "gateway_lssn": 71174,
  "test_type": "ssh"
}
```

---

## π“¥ API μ‘λ‹µ

### μ„±κ³µ (RstVal=200)

```json
{
  "RstVal": 200,
  "RstMsg": "SSH μ ‘μ† ν…μ¤νΈ μ™„λ£",
  "data": [{
    "lssn": 71221,
    "LSChkdt": "2025-11-22 14:30:00"
  }]
}
```

**μλ―Έ**: LSChkdtκ°€ μ—…λ°μ΄νΈλ¨ β…

### μ‹¤ν¨ μ‚¬λ΅€λ“¤

| RstVal | μƒν™© | μλ―Έ |
|--------|------|------|
| 422 | SSH νƒ€μ„μ•„μ›ƒ | λ¦¬λ¨νΈ μ„λ²„ μ ‘κ·Ό λ¶κ°€ |
| 404 | μ„λ²„ μ—†μ | LSSNμ΄ DBμ— μ—†μ |
| 401 | SK λ¶μΌμΉ | Secret Key μ¤λ¥ |
| 500 | μ„λ²„ μ—λ¬ | Azure Function μ¤λ¥ |

---

## β… λ‹Ήμ‹ μ ν™•μΈ (μ²΄ν¬λ°•μ¤)

λ‹¤μμ΄ λ§μΌλ©΄ μ²΄ν¬ν•΄μ£Όμ„Έμ”. κ·Έλ¬λ©΄ λ°”λ΅ μ½”λ“λ¥Ό μμ •ν•κ² μµλ‹λ‹¤.

### κµ¬μ΅° ν™•μΈ

- [ ] Gatewayκ°€ λ¦¬λ¨νΈ μ„λ²„μ— **SSH ν…μ¤νΈλ¥Ό μ§μ ‘ μ‹¤ν–‰**
- [ ] APIλ” **λ‹¨μν LSChkdtλ§ μ—…λ°μ΄νΈ** (SSH ν…μ¤νΈ λ‹¤μ‹ μ• ν•¨)

### νλΌλ―Έν„° ν™•μΈ

- [ ] jsondataλ” μ΄ 3κ°λ§:
  ```json
  {
    "lssn": 71221,
    "gateway_lssn": 71174,
    "test_type": "ssh"
  }
  ```

### text νλΌλ―Έν„° ν™•μΈ

- [ ] textλ” μ΄λ ‡κ² κ³ μ •:
  ```
  text=RemoteServerSSHTest lssn gateway_lssn test_type
  ```

### μ‘λ‹µ μ½”λ“ μ²λ¦¬ ν™•μΈ

- [ ] RstVal=200 β†’ μ„±κ³µ (LSChkdt μ—…λ°μ΄νΈλ¨)
- [ ] RstVal=422 β†’ SSH ν…μ¤νΈ μ‹¤ν¨
- [ ] RstVal=404 β†’ λ¦¬λ¨νΈ μ„λ²„ μ—†μ
- [ ] RstVal=401 β†’ SK λ¶μΌμΉ

---

## λ‹¤μ λ‹¨κ³„

λ¨λ“  μ²΄ν¬λ°•μ¤μ— μ²΄ν¬λλ©΄:

1. `lib/remote_ssh_test.sh` μμ • (νλΌλ―Έν„° μ •ν™•ν™”)
2. `lib/gateway.sh` μμ • (νΈμ¶ μ„μΉ μ •ν™•ν™”)
3. `LSChkdt_UPDATE_DIAGNOSIS.md` μ—…λ°μ΄νΈ (λ΅κΉ… ν¬μΈνΈ ν™•μ •)
4. ν…μ¤νΈ λ° κ²€μ¦

